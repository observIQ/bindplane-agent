version: 0.0.1
title: VMware vCenter
description: Log parser for VMware vCenter
parameters:
  - name: listen_port
    type: int
    default: 5140
  - name: listen_ip
    type: string
    default: "0.0.0.0"
  - name: listen_address
    type: string
    default: ""
  - name: max_buffer_size
    type: string
    default: "1024kib"
    required: false
  - name: insecure
    type: bool
    default: false
  - name: certificate_file
    type: string
    default: "/opt/cert"
    required: true
  - name: private_key_file
    type: string
    default: "/opt/key"
    required: true


  # Set Defaults
  # {{$listen_address := default "0.0.0.0:5140" .listen_address}}
  # {{$length := len $listen_address}}
  # {{$listen_ip := default "0.0.0.0" .listen_ip}}
  # {{$listen_port := default 5140 .listen_port}}
  # {{$max_buffer_size := default "1024kib" .max_buffer_size}}
  # {{$insecure := default false .insecure}}
  # {{$certificate_file := default "" .certificate_file}}
  # {{$private_key_file := default "" .private_key_file}}

template: |
  receivers:
    tcplog:
      listen_address: '{{ if eq .length 0 }}{{ .listen_ip }}:{{ .listen_port }}{{ else }}{{ .listen_address }}{{ end }}'
      max_buffer_size: {{ .max_buffer_size }}
      attributes:
        log_type: vmware_vcenter
        plugin_id: {{ .id }}
      add_attributes: true
      tls:
        insecure: {{ .insecure }}
        cert_file: {{ .certificate_file }}
        key_file: {{ .private_key_file }}
      operators:
        # vcenter will (sometimes) prepend an id to the messages, check
        # for the id and drop it if it exsits
        # example: '257 <14>1. . . '
        - id: prefix_router
          type: router
          routes:
            - output: pre_parser
            - expr: 'body matches "^\\d* "'
          default: vcenter_parser

        - id: pre_parser
          type: regex_parser
          regex: '^(?P<drop>\d* )(?P<syslog_message>[\w\W]*)'

        - id: remove_drop
          type: remove
          field: body.drop
        
        - id: move_syslog_message
          type: move
          from: body.syslog_message
          to: body

        - id: vcenter_parser
          type: syslog_parser
          protocol: rfc5424

  service:
    pipelines:
      logs:
        receivers: 
          - tcplog